<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="address">
	<select id="selectAddrCateGrpList" resultType="camel">
		/* address.selectAddrCateGrpList 주소카테고리그룹 조회*/
		SELECT	ADDRESS_CATEGORY_GRP_ID
			,	CORP_ID
			,	PROJECT_ID					/* 전용: project id 입력, 사용: ALL */
			,	ADDRESS_CATEGORY_GRP_NAME
			,	ADDRESS_CATEGORY_GRP_DESC
			,	USE_YN
			,	REG_ID
			,	REG_DT
		FROM cm_console.CM_ADDR_CATE_GRP
		WHERE 1=1
		AND	CORP_ID = #{corpId}
	</select>

	<select id="selectAddrCateGrp" parameterType="hashmap" resultType="camel">
		/* address.selectAddrCateGrp 주소록 카테고리 그룹 조회*/
		SELECT
			CACG.ADDRESS_CATEGORY_GRP_ID
			, NULL AS ADDRESS_CATEGORY_ID
			, NULL AS DIS_ORDER
			, CACG.ADDRESS_CATEGORY_GRP_NAME AS ADDRESS_NAME
			, NULL AS PAR_ADDRESS_CATEGORY_ID
		FROM cm_console.CM_ADDR_CATE_GRP CACG
		WHERE 1=1
			AND CACG.CORP_ID = #{corpId}
			AND	CACG.ADDRESS_CATEGORY_GRP_ID = #{addressCategoryGrpId}
	</select>

	<select id="selectAddrCateList" parameterType="hashmap" resultType="camel">
		/* address.selectAddrCateList 주소록 카테고리 목록 조회 */
		SELECT
			B.ADDRESS_CATEGORY_ID
			, B.ADDRESS_CATEGORY_GRP_ID
			, NULL AS GRP_DIS_ORDER
			, B.DIS_ORDER
			, B.ADDRESS_CATEGORY_NAME  AS ADDRESS_NAME
			, B.PAR_ADDRESS_CATEGORY_ID
			, B.TOP_ADDRESS_CATEGORY_ID
		FROM cm_console.CM_ADDR_CATE_GRP A
		INNER JOIN cm_console.CM_ADDR_CATE B
			ON A.ADDRESS_CATEGORY_GRP_ID = B.ADDRESS_CATEGORY_GRP_ID
			AND B.DEL_YN = 'N'
		WHERE 1=1
			AND A.CORP_ID = #{corpId}
			AND	A.ADDRESS_CATEGORY_GRP_ID = #{addressCategoryGrpId}
		ORDER BY B.DIS_ORDER
	</select>

	<select id="selectAddrMemListCnt" parameterType="hashmap" resultType="int">
		/* address.selectAddrMemListCnt 주소록 구성원 카운트 조회 */
		SELECT
			COUNT(*) AS CNT
		FROM (
			SELECT
				B.CU_INFO_ID
			,	B.CU_NAME
			,	B.CUID
			,	B.HP_NUMBER
			,	A.ADDRESS_CATEGORY_ID
			,	(SELECT ADDRESS_CATEGORY_NAME FROM cm_console.CM_ADDR_CATE WHERE ADDRESS_CATEGORY_ID = A.ADDRESS_CATEGORY_ID) AS ADDRESS_CATEGORY_NAME
			FROM (
					SELECT CU_INFO_ID, ADDRESS_CATEGORY_ID
					FROM cm_console.CM_ADDR_CATE_MEM
					WHERE ADDRESS_CATEGORY_ID IN (	SELECT	ADDRESS_CATEGORY_ID
													FROM	(	SELECT * FROM cm_console.CM_ADDR_CATE
																WHERE DEL_YN='N'
																ORDER BY PAR_ADDRESS_CATEGORY_ID, ADDRESS_CATEGORY_ID) PRODUCTS_SORTED,
															(select @pv := #{addressCategoryId}) INITIALISATION
													WHERE	FIND_IN_SET(PAR_ADDRESS_CATEGORY_ID, @pv) > 0
													AND		@pv := CONCAT(@pv, ',', ADDRESS_CATEGORY_ID)
												)
					UNION
					SELECT CU_INFO_ID, ADDRESS_CATEGORY_ID
					FROM cm_console.CM_ADDR_CATE_MEM
					WHERE ADDRESS_CATEGORY_ID = #{addressCategoryId}
			) A
			INNER JOIN cm_console.CM_CU_INFO B
			ON			A.CU_INFO_ID = B.CU_INFO_ID
			WHERE		B.USE_YN = 'Y'
			ORDER BY	B.CU_NAME ASC
		) A
	</select>
	
	<select id="selectAddrMemList" parameterType="hashmap" resultType="camel">
		/* address.selectAddrMemList 주소록 구성원 조회 */
		SELECT
			B.CU_INFO_ID
		,	B.CU_NAME
		,	B.CUID
		,	B.HP_NUMBER
		,	A.ADDRESS_CATEGORY_ID
		,	(SELECT ADDRESS_CATEGORY_NAME FROM cm_console.CM_ADDR_CATE WHERE ADDRESS_CATEGORY_ID = A.ADDRESS_CATEGORY_ID) AS ADDRESS_CATEGORY_NAME
		FROM (
				SELECT CU_INFO_ID, ADDRESS_CATEGORY_ID
				FROM cm_console.CM_ADDR_CATE_MEM
				WHERE ADDRESS_CATEGORY_ID IN (	SELECT	ADDRESS_CATEGORY_ID
												FROM	(	SELECT * FROM cm_console.CM_ADDR_CATE
															ORDER BY PAR_ADDRESS_CATEGORY_ID, ADDRESS_CATEGORY_ID) PRODUCTS_SORTED,
														(select @pv := #{addressCategoryId}) INITIALISATION
												WHERE	FIND_IN_SET(PAR_ADDRESS_CATEGORY_ID, @pv) > 0
												AND		@pv := CONCAT(@pv, ',', ADDRESS_CATEGORY_ID)
											)
				UNION
				SELECT CU_INFO_ID, ADDRESS_CATEGORY_ID
				FROM cm_console.CM_ADDR_CATE_MEM
				WHERE ADDRESS_CATEGORY_ID = #{addressCategoryId}
		) A
		INNER JOIN cm_console.CM_CU_INFO B
		ON			A.CU_INFO_ID = B.CU_INFO_ID
		WHERE		B.USE_YN = 'Y'
		ORDER BY	B.CU_NAME ASC
		<if test='pagingYn == "Y" '>
			LIMIT ${offset}, #{listSize}
		</if>
	</select>

	<select id="selectAddrProjectList" parameterType="hashmap" resultType="camel">
		/* address.selectAddrProjectList 프로젝트 목록 조회 */
		SELECT 
			B.PROJECT_ID
		,	B.PROJECT_NAME
		FROM cm_console.CM_PROJECT_USER A
		INNER JOIN cm_console.CM_PROJECT B
		ON A.PROJECT_ID = B.PROJECT_ID
		WHERE A.USER_ID = #{userId}
	</select>
	
	<insert id="insertAddrCateGrp">
		/* address.insertAddrCateGrp 주소록 등록 */
		INSERT INTO	cm_console.CM_ADDR_CATE_GRP (
				ADDRESS_CATEGORY_GRP_ID
		,		CORP_ID
		,		PROJECT_ID
		,		ADDRESS_CATEGORY_GRP_NAME
		,		ADDRESS_CATEGORY_GRP_DESC
		,		USE_YN
		,		REG_ID
		,		REG_DT
		)	VALUES (
				(SELECT IFNULL(MAX(ADDRESS_CATEGORY_GRP_ID) + 1, 1) FROM cm_console.CM_ADDR_CATE_GRP B)
		,		#{corpId}
		,		#{newProjectId}
		,		#{addressCategoryGrpName}
		,		#{addressCategoryGrpDesc}
		,		#{regUseYn}
		,		#{regId}
		,		NOW()
		)
	</insert>
	
	<update id="updateAddrCateGrp" parameterType="hashmap">
		/* address.updateAddrCateGrp 주소록 수정*/
		UPDATE cm_console.CM_ADDR_CATE_GRP
		SET
			PROJECT_ID = #{afProjectId} 
		,	ADDRESS_CATEGORY_GRP_NAME = #{addressCategoryGrpName}
		,	ADDRESS_CATEGORY_GRP_DESC = #{addressCategoryGrpDesc}
		,	USE_YN = #{useYn}
		WHERE
			ADDRESS_CATEGORY_GRP_ID = #{addressCategoryGrpId}
	</update>
	
	<select id="selectAddrCmCuListCnt" parameterType="hashmap" resultType="int">
		/* address.selectAddrCmCuListCnt 주소록 카테고리 수신자 카운트 조회 */
		SELECT
			COUNT(*) AS CNT
		FROM cm_console.CM_CU_INFO
		WHERE	USE_YN = 'Y'
		AND		CORP_ID = #{corpId}
		AND		CU_INFO_ID NOT IN (	SELECT	CU_INFO_ID
									FROM	cm_console.CM_ADDR_CATE_MEM
									WHERE	ADDRESS_CATEGORY_ID = #{addressCategoryId}
								)
		<if test="searchText != '' and searchText != null ">
			<if test="searchTextType == 'cuid' ">
		AND CUID LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'cuName' ">
		AND CU_NAME LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'hpNumber' ">
		AND HP_NUMBER LIKE CONCAT('%', #{searchText}, '%')
			</if>
		</if>
	</select>

	<select id="selectAddrCmCuList" parameterType="hashmap" resultType="camel">
		/* address.selectAddrCmCuList 주소록 카테고리 수신자 리스트 조회 */
		SELECT
				CU_INFO_ID
			,	CU_NAME
			,	CUID
			,	HP_NUMBER
		FROM cm_console.CM_CU_INFO
		WHERE	USE_YN = 'Y'
		AND		CORP_ID = #{corpId}
		AND		CU_INFO_ID NOT IN (	SELECT	CU_INFO_ID
									FROM	cm_console.CM_ADDR_CATE_MEM
									WHERE	ADDRESS_CATEGORY_ID = #{addressCategoryId}
								)
		<if test="searchText != '' and searchText != null ">
			<if test="searchTextType == 'cuid' ">
				AND CUID LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'cuName' ">
				AND CU_NAME LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'hpNumber' ">
				AND HP_NUMBER LIKE CONCAT('%', #{searchText}, '%')
			</if>
		</if>
		ORDER BY CU_INFO_ID
		<if test='pagingYn == "Y" '>
			LIMIT ${offset}, #{listSize}
		</if>
	</select>
	
	<insert id="insertAddrMemberList">
		/* address.insertAddrMemberList 구성원 등록 */
		INSERT INTO	cm_console.CM_ADDR_CATE_MEM (
				ADDRESS_CATEGORY_ID
		,		CU_INFO_ID
		,		REG_ID
		,		REG_DT
		)	VALUES (
				#{addressCategoryId}
		,		#{cuInfoId}
		,		#{regId}
		,		NOW()
		)
	</insert>
	
	<delete id="deleteAddrMember">
		/* address.deleteAddrMember 구성원삭제*/
		DELETE	FROM cm_console.CM_ADDR_CATE_MEM
		WHERE	ADDRESS_CATEGORY_ID = #{addressCategoryId}
		AND		CU_INFO_ID = #{cuInfoId}
	</delete>
	
	<select id="selectAddrRcvrListCnt" parameterType="hashmap" resultType="int">
		/* address.selectAddrRcvrListCnt 수신자 카운트 조회 */
		SELECT
			COUNT(*) AS CNT
		FROM cm_console.CM_CU_INFO
		WHERE	CORP_ID = #{corpId}
		<if test="searchText != '' and searchText != null ">
			<if test="searchTextType == 'cuid' ">
		AND CUID LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'cuName' ">
		AND CU_NAME LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'hpNumber' ">
		AND HP_NUMBER LIKE CONCAT('%', #{searchText}, '%')
			</if>
		</if>
		<if test="useYn != '' and useYn != null ">
		AND USE_YN = #{useYn}
		</if>
	</select>

	<select id="selectAddrRcvrList" parameterType="hashmap" resultType="camel">
		/* address.selectAddrRcvrList 수신자 조회 */
		SELECT
				@ROWNUM := @ROWNUM + 1 AS ROWNUM
			,	CU_INFO_ID
			,	CU_NAME
			,	CUID
			,	HP_NUMBER
			,	USE_YN
		FROM cm_console.CM_CU_INFO, (SELECT @ROWNUM:=0) TMP
		WHERE	CORP_ID = #{corpId}
		<if test="searchText != '' and searchText != null ">
			<if test="searchTextType == 'cuid' ">
		AND CUID LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'cuName' ">
		AND CU_NAME LIKE CONCAT('%', #{searchText}, '%')
			</if>
			<if test="searchTextType == 'hpNumber' ">
		AND HP_NUMBER LIKE CONCAT('%', #{searchText}, '%')
			</if>
		</if>
		<if test="useYn != '' and useYn != null ">
		AND USE_YN = #{useYn}
		</if>
		ORDER BY CU_INFO_ID ASC
		<if test='pagingYn == "Y" '>
			LIMIT ${offset}, #{listSize}
		</if>
	</select>
	
	<insert id="insertAddRcvr">
		/* address.insertAddRcvr 수신자 등록 */
		INSERT INTO cm_console.CM_CU_INFO (
				CU_INFO_ID
		,		CU_NAME
		,		CUID
		,		HP_NUMBER
		,		USE_YN
		,		REG_ID
		,		REG_DT
		,		UPD_ID
		,		UPD_DT
		,		CORP_ID
		)	VALUES (
				(SELECT IFNULL(MAX(CU_INFO_ID) + 1, 1) FROM cm_console.CM_CU_INFO B)
		,		#{cuName}
		,		#{cuid}
		,		#{hpNumber}
		,		#{useYn}
		,		#{loginId}
		,		NOW()
		,		#{loginId}
		,		NOW()
		,		#{corpId}
		)
	</insert>
	
	<update id="updateAddrRcvr" parameterType="hashmap">
		/* address.updateAddrRcvr 수신자 수정*/
		UPDATE cm_console.CM_CU_INFO
		SET
			<if test="cuName != '' and cuName != null ">
			CU_NAME	= #{cuName},
			</if>
			<if test="cuid != '' and cuid != null ">
			CUID	= #{cuid},
			</if>
			<if test="hpNumber != '' and hpNumber != null ">
			HP_NUMBER	= #{hpNumber},
			</if>
			<if test="useYn != '' and useYn != null ">
			USE_YN	= #{useYn},
			</if>
			UPD_DT = NOW()
		WHERE CU_INFO_ID	= #{cuInfoId}
	</update>
	
	<select id="selectAddrRcvrCnt" parameterType="hashmap" resultType="int">
		/* address.selectAddrRcvrCnt 카테고리 구성원관리 테이블에서 수신자 조회 */
		SELECT
			COUNT(*) AS CNT
		FROM cm_console.CM_ADDR_CATE_MEM
		WHERE	CU_INFO_ID = #{cuInfoId}
	</select>
	
	<delete id="deleteAddrRcvr">
		/* address.deleteAddrRcvr 수신자 삭제*/
		DELETE	FROM cm_console.CM_CU_INFO
		WHERE	CU_INFO_ID = #{cuInfoId}
	</delete>
	
	<insert id="insertAddrCate">
	/* address.insertAddrCate 주소 카테고리 등록 */
	INSERT INTO cm_console.CM_ADDR_CATE (
			ADDRESS_CATEGORY_ID
		,	ADDRESS_CATEGORY_GRP_ID
		,	DIS_ORDER
		,	ADDRESS_CATEGORY_NAME
		,	PAR_ADDRESS_CATEGORY_ID
		,	DEL_YN
		,	REG_ID
		,	REG_DT
		,	UPD_ID
		,	UPD_DT
	)
		VALUES (
			(SELECT IFNULL(MAX(ADDRESS_CATEGORY_ID) + 1, 1) FROM cm_console.CM_ADDR_CATE B)
		,	#{addressCategoryGrpId}
		,	(	SELECT	IFNULL(MAX(DIS_ORDER) + 1, 1)
				FROM	cm_console.CM_ADDR_CATE B
				WHERE	ADDRESS_CATEGORY_GRP_ID = #{addressCategoryGrpId}
				AND		PAR_ADDRESS_CATEGORY_ID = #{parAddressCategoryId}
				AND		DEL_YN = 'N'
			)
		,	#{addressCategoryName}
		,	#{parAddressCategoryId}
		,	'N'
		,	#{regId}
		,	NOW()
		,	#{regId}
		,	NOW()
	)
	</insert>
	
	<select id="selectAddrSubCategory" parameterType="hashmap" resultType="int">
		/* address.selectAddrRcvrCnt 하위 카테고리 조회 */
		SELECT
			COUNT(*) AS CNT
		FROM cm_console.CM_ADDR_CATE_MEM
		WHERE	CU_INFO_ID = #{cuInfoId}
	</select>

	<update id="updateAddrCate">
		/* address.updateAddrCate 주소카테고리수정 */
		UPDATE	cm_console.CM_ADDR_CATE
		SET		ADDRESS_CATEGORY_NAME = #{addressCategoryName}
			,	UPD_DT = NOW()
			,	UPD_ID = #{regId}
		WHERE	ADDRESS_CATEGORY_ID = #{addressCategoryId}
	</update>

	<update id="deleteAddrCate">
		/* address.deleteAddrCate 주소카테고리삭제 하위카테고리까지 삭제*/
		UPDATE	cm_console.CM_ADDR_CATE
		SET		DEL_YN = 'Y'
			,	UPD_DT = NOW()
			,	UPD_ID = #{regId}
		WHERE	ADDRESS_CATEGORY_ID = #{addressCategoryId}
		OR	ADDRESS_CATEGORY_ID IN (
				SELECT	ADDRESS_CATEGORY_ID
				FROM	(	SELECT * FROM cm_console.CM_ADDR_CATE
							WHERE DEL_YN='N'
							ORDER BY PAR_ADDRESS_CATEGORY_ID, ADDRESS_CATEGORY_ID) PRODUCTS_SORTED,
						(select @pv := #{addressCategoryId}) INITIALISATION
				WHERE	FIND_IN_SET(PAR_ADDRESS_CATEGORY_ID, @pv) > 0
				AND		@pv := CONCAT(@pv, ',', ADDRESS_CATEGORY_ID)
			)
	</update>
	
	<delete id="deleteAddrCateMember">
		/* address.deleteAddrCateMember 주소카테고리 삭제시 구성원 삭제 (하위 카테고리의 구성원까지 삭제)*/
		DELETE	FROM cm_console.CM_ADDR_CATE_MEM
		WHERE	ADDRESS_CATEGORY_ID = #{addressCategoryId}
		OR	ADDRESS_CATEGORY_ID IN (
				SELECT	ADDRESS_CATEGORY_ID
				FROM	(	SELECT * FROM cm_console.CM_ADDR_CATE
							WHERE DEL_YN='N'
							ORDER BY PAR_ADDRESS_CATEGORY_ID, ADDRESS_CATEGORY_ID) PRODUCTS_SORTED,
						(select @pv := #{addressCategoryId}) INITIALISATION
				WHERE	FIND_IN_SET(PAR_ADDRESS_CATEGORY_ID, @pv) > 0
				AND		@pv := CONCAT(@pv, ',', ADDRESS_CATEGORY_ID)
			)
	</delete>
</mapper>