<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="integratedSend">

    <sql id ="whereSelectIntegratedSendList">
        <!-- AND A.CORP_ID = #{corpId} -->
        AND A.TMPLT_STATUS = 'COMPLETE'
        AND A.TMPLT_TYPE = 'M'
		AND (A.PROJECT_ID = #{projectId} || A.PROJECT_ID = 'ALL')
        <if test="searchText != '' and searchText != null ">
            AND A.TMPLT_TITLE = CONCAT('%', #{searchText}, '%')
        </if>
        <if test="searchStartDate != '' and searchStartDate != null ">
            <if test="searchEndDate != '' and searchEndDate != null ">
            AND A.REG_DT BETWEEN CONCAT(#{searchStartDate}, ' 00:00:00') AND CONCAT(#{searchEndDate}, ' 23:59:59')
            </if>
        </if>
    </sql>

    <select id="selectIntegratedSendListCnt" parameterType="hashmap" resultType="int">
    /* 통합발송 템플릿 카운트 조회 */
        SELECT
            COUNT(PROJECT_ID) AS CNT
        FROM cm.CM_SMART_TMPLT A
        WHERE 1=1
        <include refid="whereSelectIntegratedSendList"/>
    </select>

    <select id="selectIntegratedSendList" parameterType="hashmap" resultType="camel">
    /* 통합발송 템플릿 리스트 조회 */
		SELECT  @rownum:=@rownum+1 AS ROW_NUM
		      , A.PROJECT_ID
		      , CASE WHEN A.PROJECT_ID = 'ALL' THEN '프로젝트 공용'
		             ELSE '프로젝트 개별'
		        END AS otherProjectUseYn
		      , A.TMPLT_CODE
		      , A.MSG_KIND
		      , C.CODE_NAME_1 AS MSG_KIND_NAME
		      , A.MSG_TYPE
		      , D.CODE_NAME_1 AS MSG_TYPE_NAME
		      , A.TMPLT_TITLE
		      , A.TMPLT_INFO
		      , A.TMPLT_TYPE
		      , A.USE_YN
		      , A.TMPLT_INFO ->> '$[0].chTypeList' AS TMPLT_CHANNEL
		      , JSON_EXTRACT(A.TMPLT_INFO, '$[*].chType') CHECKED_CHANNEL
		      , A.REG_ID
		      , A.REG_DT
		FROM cm.CM_SMART_TMPLT A LEFT OUTER JOIN cm_bo.CM_CODE C ON A.MSG_KIND = C.CODE_VAL_1 AND C.CODE_TYPE_CD = 'MSG_KIND'
		                         LEFT OUTER JOIN cm_bo.CM_CODE D ON A.MSG_TYPE = D.CODE_VAL_1 AND D.CODE_TYPE_CD = 'MSG_TYPE'
		   , (SELECT @rownum:=0) TMP
		WHERE 1=1
		<include refid="whereSelectIntegratedSendList"/>
		ORDER BY A.REG_DT DESC
        <if test='pagingYn == "Y" '>
        LIMIT ${offset}, #{listSize}
        </if>
    </select>

</mapper>