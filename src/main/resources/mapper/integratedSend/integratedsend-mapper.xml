<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="integratedSend">

    <sql id ="whereSelectIntegratedSendList">
        <!-- AND A.CORP_ID = #{corpId} -->
        AND A.TMPLT_STATUS = 'COMPLETE'
        AND A.TMPLT_TYPE = 'M'
        AND (A.PROJECT_ID = #{projectId} || A.PROJECT_ID = 'ALL')
        AND JSON_CONTAINS(JSON_ARRAY(<foreach collection="useChGrps" item="item" separator=",">#{item}</foreach>), JSON_EXTRACT(A.TMPLT_INFO, '$[*].chType'), '$') > 0
        <if test="searchText != '' and searchText != null ">
            <if test="searchCondi == 'templateChannel' ">
            AND UPPER(A.TMPLT_INFO ->> '$[0].chTypeList') LIKE CONCAT('%', UPPER(#{searchText}), '%')
            </if>
            <if test="searchCondi == 'templateName' ">
            AND A.TMPLT_TITLE LIKE CONCAT('%', #{searchText}, '%')
            </if>
        </if>

        <if test="searchStartDate != '' and searchStartDate != null ">
            <if test="searchEndDate != '' and searchEndDate != null ">
            AND A.REG_DT BETWEEN CONCAT(#{searchStartDate}, ' 00:00:00') AND CONCAT(#{searchEndDate}, ' 23:59:59')
            </if>
        </if>
    </sql>

    <select id="selectIntegratedSendListCnt" parameterType="hashmap" resultType="int">
    /* 통합발송 템플릿 카운트 조회 */
        SELECT
            COUNT(PROJECT_ID) AS CNT
        FROM cm.CM_SMART_TMPLT A
        WHERE 1=1
        <include refid="whereSelectIntegratedSendList"/>
    </select>

    <select id="selectIntegratedSendList" parameterType="hashmap" resultType="camel">
    /* 통합발송 템플릿 리스트 조회 */
		SELECT  @rownum:=@rownum+1 AS ROW_NUM
		      , A.PROJECT_ID
		      , CASE WHEN A.PROJECT_ID = 'ALL' THEN '프로젝트 공용'
		             ELSE '프로젝트 개별'
		        END AS otherProjectUseYn
		      , A.TMPLT_CODE
		      , A.MSG_KIND
		      , cm_console.fnc_get_cd_name('MSG_KIND', A.MSG_KIND, 1) AS MSG_KIND_NAME
		      , A.MSG_TYPE
		      , cm_console.fnc_get_cd_name('MSG_TYPE', A.MSG_TYPE, 1) AS MSG_TYPE_NAME
		      , A.TMPLT_TITLE
		      , A.TMPLT_INFO
		      , A.TMPLT_TYPE
		      , A.USE_YN
 		      <!-- , A.TMPLT_INFO ->> '$[0].chTypeList' AS TMPLT_CHANNEL -->
		      , REPLACE(A.TMPLT_INFO ->> '$[0].chTypeList', 'SMSMMS', 'SMS/MMS') AS TMPLT_CHANNEL
		      , JSON_EXTRACT(A.TMPLT_INFO, '$[*].chType') CHECKED_CHANNEL
		      , A.REG_ID
		      , cm_console.fnc_get_user_name(A.REG_ID) AS REG_NM
		      , A.REG_DT
		FROM (SELECT @rownum:=0) TMP,
            cm.CM_SMART_TMPLT A
		WHERE 1=1
		<include refid="whereSelectIntegratedSendList"/>
		ORDER BY A.REG_DT DESC
        <if test='pagingYn == "Y" '>
        LIMIT #{offset}, #{listSize}
        </if>
    </select>

</mapper>