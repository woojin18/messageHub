<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cash">
	<insert id="insertWebCashInfo">
		/* cash.insertWebCashInfo */
		INSERT	cm_console.CM_WEB_CASH_HIST (
				CORP_ID
		,		CASH_ID
		,		PAYMENT_ID
		,		PAY_MTD
		,		STATUS
		,		CASH_CHARG_AMOUNT
		,		REG_DT
		,		UPD_DT
		) VALUES (
				#{corpId}
		,		#{cashId}
		,		#{orderId}
		,		#{payMtd}
		,		#{status}
		,		#{amount}
		,		NOW()
		,		NOW()
		)
	</insert>
	
	<select id="selectWebCashInfo" resultType="camel">
		/* cash.selectWebCashInfo */
		SELECT	PAYMENT_ID							AS ORDER_ID
		,		CAST(CASH_CHARG_AMOUNT AS unsigned)	AS AMOUNT
		FROM	cm_console.CM_WEB_CASH_HIST
		WHERE	PAYMENT_ID = #{orderId}
	</select>
	
	<select id="selectCashId" resultType="String">
		/* selectCashId */
		SELECT	IFNULL(cc.CASH_ID, '') AS CASH_ID
		FROM	cm.CM_CASH cc 
		WHERE	cc.CORP_ID = #{corpId}
		AND		cc.CASH_TYPE = 'C'
		AND		cc.USE_YN = 'Y'
	</select>
	
	<update id="updateWebCashInfo">
		/* cash.updateWebCashInfo */
		UPDATE	cm_console.CM_WEB_CASH_HIST
		SET		APPROVAL_NUMBER = #{approvalNumber}
		,		CARD_COMPANY = #{cardCompany}
		,		RECEIPT_URL = #{receiptUrl}
		,		STATUS = #{status}
		,		UPD_DT = NOW()
		WHERE	PAYMENT_ID = #{orderId}
	</update>
	
	<select	id ="selectCashHist_count" resultType="int">
		/* cash.selectCashHist_count */
		SELECT	COUNT(*)
		FROM	(
				SELECT	CASH_CHARG_AMOUNT	AS AMOUNT
				,		'충전캐시'				AS CASH_TYPE
				,		PAY_MTD
				,		DATE_FORMAT(REG_DT, '%Y-%m-%d')	AS REG_DT
				,		'-'					AS EVENT_DT
				FROM	cm_console.CM_WEB_CASH_HIST
				WHERE	STATUS = '1'
				AND		CORP_ID = #{corpId}
				UNION ALL
				SELECT	cch.AMOUNT
				,		'이벤트캐시'
				,		'이벤트캐시'
				,		DATE_FORMAT(cc.REG_DT, '%Y-%m-%d')
				,		DATE_FORMAT(cc.START_DT, '%Y-%m-%d') + '~' + DATE_FORMAT(cc.EXP_DT, '%Y-%m-%d')
				FROM	cm.CM_CASH cc
				INNER JOIN (
					SELECT	MAX(AMOUNT)	AS AMOUNT
					FROM	cm.CM_CASH_HIST
					GROUP BY CORP_ID, CASH_ID
				) cch
				WHERE	cc.CORP_ID = #{corpId}
				AND		cc.CASH_TYPE = 'E'
		) AA
	</select>
	
	<select	id ="selectCashHist" resultType="camel">
		/* cash.selectCashHist */
		SELECT	CASH_CHARG_AMOUNT	AS AMOUNT
		,		'충전캐시'				AS CASH_TYPE
		,		PAY_MTD
		,		DATE_FORMAT(REG_DT, '%Y-%m-%d')	AS REG_DT
		,		'-'					AS EVENT_DT
		FROM	cm_console.CM_WEB_CASH_HIST
		WHERE	STATUS = '1'
		AND		CORP_ID = #{corpId}
		
		UNION ALL
		
		SELECT	cch.AMOUNT
		,		'이벤트캐시'
		,		'이벤트캐시'
		,		DATE_FORMAT(cc.REG_DT, '%Y-%m-%d')
		,		DATE_FORMAT(cc.START_DT, '%Y-%m-%d') + '~' + DATE_FORMAT(cc.EXP_DT, '%Y-%m-%d')
		FROM	cm.CM_CASH cc
		INNER JOIN (
			SELECT	MAX(AMOUNT)	AS AMOUNT
			,		CORP_ID
			,		CASH_ID
			FROM	cm.CM_CASH_HIST
			GROUP BY CORP_ID, CASH_ID
		) cch
			ON	cc.CORP_ID = cch.CORP_ID
			AND	cc.CASH_ID = cch.CASH_ID
		WHERE	cc.CORP_ID = #{corpId}
		AND		cc.CASH_TYPE = 'E'
		ORDER BY REG_DT DESC
        <if test='pagingYn == "Y" '>
        LIMIT #{offset}, #{listSize}
        </if>
	</select>
	
	<select id="selectUcubeInfo" resultType="camel">
		/* cash.selectUcubeInfo */
		SELECT	DISTINCT cp.SERVICE_ID AS A
		,		cu.BILL_ID
		,		DATE_FORMAT(cu.REG_DT, '%Y-%m-%d')	AS REG_DT
		FROM cm_console.CM_PROJECT cp 
		INNER JOIN cm_console.CM_UCUBE cu 
			ON cp.BILL_ID = cu.BILL_ID 
		WHERE	cp.CORP_ID = #{corpId}
	</select>
	
	<select id="selectProjectInfoCnt" resultType="int">
		/* cash.selectProjectInfoCnt */
		SELECT	COUNT(cp.PROJECT_ID)
		FROM	cm_console.CM_PROJECT cp
		INNER JOIN cm_console.CM_UCUBE cu
			ON	cp.CORP_ID = cu.CORP_ID
			AND	cp.BILL_ID = cu.BILL_ID
		WHERE	cp.CORP_ID = #{corpId}
	</select>
	
	<select id="selectProjectInfo" resultType="camel">
		/* cash.selectProjectInfo */
		SELECT	cp.PROJECT_NAME
		,		cp.PROJECT_ID
		,		cp.BILL_ID
		,		DATE_FORMAT(cp.REG_DT, '%Y-%m-%d')	AS REG_DT
		,		cp.USE_YN
		,		JSON_EXTRACT(cu.UCUBE_INFO, '$.b')	AS B
		,		JSON_EXTRACT(cu.UCUBE_INFO, '$.a')	AS A
		FROM	cm_console.CM_PROJECT cp
		INNER JOIN cm_console.CM_UCUBE cu
			ON	cp.CORP_ID = cu.CORP_ID
			AND	cp.BILL_ID = cu.BILL_ID
		WHERE	cp.CORP_ID = #{corpId}
	</select>
	
	<select id="selectProjectSubBillCodeCnt" resultType="int">
		/* cash.selectProjectSubBillCodeCnt */
		SELECT	COUNT(cpsc.DEPT_CODE)
		FROM	cm_console.CM_PROJECT_SUBBILL_CODE cpsc
		INNER JOIN cm_console.CM_UCUBE cu
			ON	cpsc.CORP_ID = cu.CORP_ID
			AND	cpsc.BILL_ID = cu.BILL_ID
		WHERE	cpsc.CORP_ID = #{corpId}
	</select>
	
	<select id="selectProjectSubBillCode" resultType="camel">
		/* cash.selectProjectSubBillCode */
		SELECT	cpsc.DEPT_CODE
		,		cpsc.DEPT_NAME
		,		DATE_FORMAT(cpsc.UPD_DT, '%Y-%m-%d')	AS UPD_DT
		,		cpsc.USE_YN
		,		JSON_EXTRACT(cu.UCUBE_INFO, '$.a')		AS A
		,		cpsc.BILL_ID
		FROM	cm_console.CM_PROJECT_SUBBILL_CODE cpsc
		INNER JOIN cm_console.CM_UCUBE cu
			ON	cpsc.CORP_ID = cu.CORP_ID
			AND	cpsc.BILL_ID = cu.BILL_ID
		WHERE	cpsc.CORP_ID = #{corpId}
	</select>
	
	<insert id="insertUcubeInfo">
		/* cash.insertUcubeInfo */
		INSERT	cm_console.CM_UCUBE(
			CORP_ID
		,	BILL_ID
		,	UCUBE_INFO
		,	REG_DT
		,	UPD_DT
		)
		VALUES (
			#{corpId}
		,	#{billId}
		,	#{ucubeInfo}
		,	NOW()
		,	NOW()
		);
	</insert>
	
	<update id="updateProjectBillId">
		/* cash.insertUcubeInfo */
		UPDATE	cm_console.CM_PROJECT
		SET		BILL_ID = #{billId}
		WHERE	PROJECT_ID = #{projectId}
		AND		CORP_ID = #{corpId}
	</update>
	
	<insert id="insertProjectSubBillCode">
		/* cash.insertProjectSubBillCode */
		INSERT	cm_console.CM_PROJECT_SUBBILL_CODE (
				DEPT_CODE
		,		BILL_ID
		,		CORP_ID
		,		USE_YN
		,		DEPT_NAME
		,		REG_DT
		,		UPD_DT
		) VALUES (
				#{deptCode}
		,		#{billId}
		,		#{corpId}
		,		#{useYn}
		,		#{deptName}
		,		NOW()
		,		NOW()
		)
	</insert>
	
	<update id="updateProjectSubBillCode">
		/* cash.updateProjectSubBillCode */
		UPDATE	cm_console.CM_PROJECT_SUBBILL_CODE
		SET		BILL_ID = #{billId}
		,		DEPT_NAME = #{deptName}
		,		USE_YN = #{useYn}
		,		UPD_DT = NOW()
		WHERE	DEPT_CODE = #{deptCode}
		AND		CORP_ID = #{corpId}
	</update>
	
	<delete id="deleteProjectSubBillCode">
		/* cash.deleteProjectSubBillCode */
		DELETE FROM	cm_console.CM_PROJECT_SUBBILL_CODE
		WHERE	DEPT_CODE = #{deptCode}
		AND		CORP_ID = #{corpId}
		AND		USE_YN = 'N'
	</delete>
	
	<select id="selectCashHistInfoForPaymentId" resultType="camel">
		/* cash.selectCashHistInfoForPaymentId */
		SELECT	CORP_ID
		,		CASH_ID
		FROM	cm_console.CM_WEB_CASH_HIST cwch 
		WHERE	cwch.PAYMENT_ID = #{orderId}
	</select>
	
	<select id="selectEventCashBalance" resultType="int">
		/* cash.selectEventCashBalance */
		SELECT	IFNULL(SUM(cc.CASH_BALANCE), 0) AS BALANCE
		FROM	cm.CM_CASH cc 
		WHERE	cc.CORP_ID = #{corpId}
		AND		cc.CASH_TYPE = 'E'
	</select>
	
	<select id="selectCashInfoForCorpIdCashType" resultType="camel">
		/* cash.selectCashInfoForCorpIdCashType */
		SELECT	CORP_ID
		,		CASH_ID
		FROM	cm.CM_CASH cc
		WHERE	cc.CORP_ID = #{corpId}
		AND		cc.CASH_TYPE = 'C'
	</select>
	
</mapper>