<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="callnum">

	<insert id="insertCallNum">
        /* callnum.insertCallNum - 문자발신번호 등록 */
        INSERT INTO cm_console.CM_CALL_NUM (
               CORP_ID
             , CALL_NUM
             , STATE
             , REG_WAY
             , CHATBOT_ID
             , JOIN_FILE_ID
             , REQ_ID
             , REQ_DT
             , REG_ID
             , REG_DT
             , UPD_ID
             , UPD_DT
        ) VALUES (
               #{corpId}
             , #{callNum}
             , #{state}
             , #{regWay}
             , #{chatbotId}
             , #{joinFileId}
             , #{userId}
             , NOW()
             , #{userId}
             , NOW()
             , #{userId}
             , NOW()
        )
	</insert>
    
    <delete id="deleteCallNum">
        /* callnum.deleteCallNum - 문자발신번호 삭제 */
        DELETE FROM cm_console.CM_CALL_NUM
         WHERE CORP_ID       = #{corpId}
           AND CALL_NUM      = #{callNum}
    </delete>
    
    <select id="selectCallNumCnt" resultType="int">
        /* callnum.selectCallNumCnt - 문자발신번호 건수 조회 */
        SELECT (
        SELECT COUNT(1) AS CNT 
          FROM cm_console.CM_CALL_NUM a
          LEFT JOIN cm.CM_RCS_CHATBOT b
            ON b.CHATBOT_ID = a.CHATBOT_ID
                AND EXISTS (
                    SELECT 1 
                    FROM   cm.CM_RCS_BRAND X
                    INNER JOIN cm_console.CM_PROJECT_BRAND Y
                       ON   Y.BRAND_ID = X.BRAND_ID
                       AND Y.PROJECT_ID = #{projectId}
                       AND X.USE_YN = 'Y'
               )
             , cm_console.CM_PROJECT_CALL_NUM c
         WHERE a.CORP_ID       = c.CORP_ID 
           AND a.CALL_NUM      = c.CALL_NUM
           AND a.CORP_ID       = #{corpId}
           AND c.PROJECT_ID    = #{projectId}
        <if test="srcCallNum != null and srcCallNum != ''">
           AND a.CALL_NUM LIKE CONCAT('%',#{srcCallNum},'%')
        </if>
        <if test="srcRcsState != null and srcRcsState != ''">
           AND b.APPROVAL_STATUS = #{srcRcsState}
        </if>
        <if test="srcSmsState != null and srcSmsState != ''">
           AND a.STATE = #{srcSmsState}
        </if>
               ) + (
        SELECT COUNT(1)
          FROM cm.CM_RCS_CHATBOT_REQ a
         WHERE a.CORP_ID       = #{corpId}
           AND a.PROJECT_ID    = #{projectId}
        <if test="srcCallNum != null and srcCallNum != ''">
           AND a.CHATBOT_ID LIKE CONCAT('%',#{srcCallNum},'%')
        </if>
        <if test="srcRcsState != null and srcRcsState != ''">
           AND APPROVAL_STATUS = #{srcRcsState}
        </if>
		   AND NOT EXISTS (SELECT 1
                FROM cm_console.CM_CALL_NUM b
               WHERE a.CHATBOT_ID = b.CALL_NUM)
               ) AS CNT 
    </select>
    
    <select id="selectCallNumList" resultType="camel">
        /* callnum.selectCallNumList - 문자발신번호 목록 조회 */
        SELECT a.CALL_NUM
             , (CASE WHEN b.CHATBOT_ID IS NULL THEN '' ELSE 'O' END) AS RCS_SEND
             , b.APPROVAL_STATUS                                  AS RCS_STATE
             , REPLACE(JSON_EXTRACT(b.CHATBOT_INFO , '$.isMainNum[0]'), "\"", "") AS IS_MAIN_NUM
             , REPLACE(JSON_EXTRACT(b.CHATBOT_INFO , '$.approvalReason[0]'), "\"", "") AS APPROVAL_REASON
             , 'O'                                                AS SMS_SEND
             , STATE AS SMS_STATE
             , (CASE STATE WHEN '10' THEN '요청' WHEN '20' THEN '접수' WHEN '80' THEN '승인' WHEN '90' THEN '반려' WHEN '91' THEN '차단' END) AS SMS_STATE_NM
             , (CASE REG_WAY WHEN 'PHONE' THEN '휴대폰 인증' WHEN 'RCS' THEN 'RCS Biz' WHEN 'DOC' THEN '서류 심사' WHEN 'PROXY' THEN '대리인' WHEN 'ETC' THEN '기타' END) AS REG_WAY
             , b.BRAND_ID
             , (SELECT BRAND_NAME FROM cm.CM_RCS_BRAND x WHERE x.BRAND_ID = b.BRAND_ID) AS BRAND
             , (SELECT GROUP_CONCAT(CONCAT(PROJECT_NAME, '|!|', x.PROJECT_ID) separator '|@|') FROM cm_console.CM_PROJECT x, cm_console.CM_PROJECT_CALL_NUM y WHERE y.CORP_ID = a.CORP_ID AND y.CALL_NUM = a.CALL_NUM AND x.PROJECT_ID = y.PROJECT_ID AND x.CORP_ID = y.CORP_ID)  AS PROJECT 
             , DATE_FORMAT(REQ_DT, '%Y-%m-%d')    AS REQ_DT 
             , DATE_FORMAT(HANDLE_DT, '%Y-%m-%d') AS HANDLE_DT 
             , HANDLE_REASON
             , b.CHATBOT_ID
          FROM cm_console.CM_CALL_NUM a 
          LEFT JOIN cm.CM_RCS_CHATBOT b
            ON b.CHATBOT_ID = a.CHATBOT_ID
             AND EXISTS (
                    SELECT 1 
                    FROM   cm.CM_RCS_BRAND X
                    INNER JOIN cm_console.CM_PROJECT_BRAND Y
                       ON   Y.BRAND_ID = X.BRAND_ID
                       AND Y.PROJECT_ID = #{projectId}
                       AND X.USE_YN = 'Y'
                    )
             , cm_console.CM_PROJECT_CALL_NUM c
         WHERE a.CORP_ID       = c.CORP_ID 
           AND a.CALL_NUM      = c.CALL_NUM
           AND a.CORP_ID       = #{corpId}
           AND c.PROJECT_ID    = #{projectId} 
        <if test="srcCallNum != null and srcCallNum != ''">
           AND a.CALL_NUM LIKE CONCAT('%',#{srcCallNum},'%')
        </if>
        <if test="srcRcsState != null and srcRcsState != ''">
           AND b.APPROVAL_STATUS = #{srcRcsState}
        </if>
        <if test="srcSmsState != null and srcSmsState != ''">
           AND a.STATE = #{srcSmsState}
        </if>
		UNION ALL 
		SELECT CHATBOT_ID AS CALLNUM
		     , 'O' AS RCS_SEND
		     , APPROVAL_STATUS AS RCS_STATE
             , REPLACE(JSON_EXTRACT(a.CHATBOT_INFO , '$.isMainNum[0]'), "\"", "") AS IS_MAIN_NUM
             , REPLACE(JSON_EXTRACT(a.CHATBOT_INFO , '$.approvalReason[0]'), "\"", "") AS APPROVAL_REASON
		     , '' AS SMS_SEND
		     , '' AS SMS_STATE
		     , '' AS SMS_STATE_NM
		     , 'RCS Biz' AS REG_WAY
		     , a.BRAND_ID
		     , (SELECT BRAND_NAME FROM cm.CM_RCS_BRAND x WHERE x.BRAND_ID = a.BRAND_ID)
		     , '' AS PROJECT_NAME 
		     , DATE_FORMAT(a.REG_DT, '%Y-%m-%d')
		     , '' AS HANDLE_DT 
		     , '' AS HANDLE_REASON
		     , CHATBOT_ID
		  FROM cm.CM_RCS_CHATBOT_REQ a
		 WHERE a.CORP_ID       = #{corpId}
		   AND a.PROJECT_ID    = #{projectId}
        <if test="srcCallNum != null and srcCallNum != ''">
           AND a.CHATBOT_ID LIKE CONCAT('%',#{srcCallNum},'%')
        </if>
        <if test="srcRcsState != null and srcRcsState != ''">
           AND APPROVAL_STATUS = #{srcRcsState}
        </if>
           AND NOT EXISTS (SELECT 1
                FROM cm_console.CM_CALL_NUM b
               WHERE a.CHATBOT_ID = b.CALL_NUM)
         ORDER BY 13 DESC
        <if test='pagingYn == "Y" '>
         LIMIT #{offset}, #{listSize}
        </if>
    </select>
    
    <select id="selectProjectCallNumCnt" resultType="int">
        /* callnum.selectProjectCallNumCnt - 문자발신번호 건수 */
        SELECT COUNT(1)
          FROM cm_console.CM_PROJECT_CALL_NUM
         WHERE CORP_ID       = #{corpId}
           AND CALL_NUM      = #{callNum}
    </select>
 
    <insert id="insertProjectCallNum">
        /* callnum.insertProjectCallNum - 프로젝트별 문자발신번호 등록 */
        INSERT INTO cm_console.CM_PROJECT_CALL_NUM (
               PROJECT_ID
             , CORP_ID
             , CALL_NUM
             , REG_ID
             , REG_DT
        ) VALUES (
               #{projectId}
             , #{corpId}
             , #{callNum}
             , #{userId}
             , NOW()
        )
    </insert>
    
    <delete id="deleteProjectCallNum">
        /* callnum.deleteProjectCallNum - 프로젝트별 문자발신번호 삭제 */
        DELETE FROM cm_console.CM_PROJECT_CALL_NUM
         WHERE CORP_ID       = #{corpId}
           AND PROJECT_ID    = #{projectId}
           AND CALL_NUM      = #{callNum}
    </delete>
 
    <insert id="insertProjectChatbot">
        /* callnum.insertProjectChatbot - 프로젝트별 RCS챗봇 등록 */
        INSERT INTO cm_console.CM_PROJECT_CHATBOT (
               PROJECT_ID
             , CHATBOT_ID
             , REG_ID
             , REG_DT
        )
        SELECT #{projectId}
             , CHATBOT_ID
             , #{userId}
             , NOW()
          FROM cm_console.CM_CALL_NUM
         WHERE CORP_ID       = #{corpId}
           AND CALL_NUM      = #{callNum}
           AND CHATBOT_ID    > ''
    </insert>
    
    <delete id="deleteProjectChatbot">
        /* callnum.deleteProjectChatbot - 프로젝트별 RCS챗봇 삭제 */
        DELETE FROM cm_console.CM_PROJECT_CHATBOT
         WHERE PROJECT_ID    = #{projectId}
           AND CHATBOT_ID    = #{chatbotId}
    </delete>

    <insert id="insertCallNumProxy">
        /* callnum.insertCallNumProxy - 문자발신번호 대리인 등록 */
        INSERT INTO cm_console.CM_CALL_NUM_PROXY (
               CORP_ID
             , STATE
             , AGREE_FILE_ID
             , REQ_FILE_ID
             , SEAL_FILE_ID
             , AUTH_FILE_ID
             , WORK_FILE_ID
             , REQ_ID
             , REQ_DT
             , REG_ID
             , REG_DT
             , UPD_ID
             , UPD_DT
        ) VALUES (
               #{corpId}
             , #{state}
             , #{agreeFileId}
             , #{reqFileId}
             , #{sealFileId}
             , #{authFileId}
             , #{workFileId}
             , #{userId}
             , NOW()
             , #{userId}
             , NOW()
             , #{userId}
             , NOW()
        )
    </insert>

    <update id="updateCallNumProxy">
        /* callnum.updateCallNumProxy - 문자발신번호 대리인 수정 */
        UPDATE cm_console.CM_CALL_NUM_PROXY
           SET STATE         = #{state}
             , AGREE_FILE_ID = #{agreeFileId}
             , REQ_FILE_ID   = #{reqFileId}
             , SEAL_FILE_ID  = #{sealFileId}
             , AUTH_FILE_ID  = #{authFileId}
             , WORK_FILE_ID  = #{workFileId}
             , REQ_ID        = #{userId}
             , REQ_DT        = NOW()
             , HANDLE_ID     = NULL
             , HANDLE_DT     = NULL
             , HANDLE_REASON = NULL
             , UPD_ID        = #{userId}
             , UPD_DT        = NOW()
         WHERE CORP_ID       = #{corpId}
    </update>
    
    <select id="selectCallNumProxy" resultType="camel">
        SELECT STATE
             , HANDLE_REASON
          FROM cm_console.CM_CALL_NUM_PROXY
         WHERE CORP_ID       = #{corpId}
         LIMIT 0, 1
    </select>
    
    <select id="selectRcsCallNumCnt" resultType="int">
        /* callnum.selectRcsCallNumCnt - RCS발신번호 건수 조회 */
        SELECT COUNT(1) AS CNT 
		FROM   cm.CM_RCS_CHATBOT A
		INNER JOIN cm.CM_RCS_BRAND B
  		 ON   B.BRAND_ID = A.BRAND_ID 
   		AND   B.USE_YN = 'Y'
   		AND   B.APPROVAL_STATUS = '승인'
		INNER JOIN cm_console.CM_PROJECT_BRAND C
 		  ON   C.BRAND_ID = B.BRAND_ID 
		WHERE   A.USE_YN = 'Y'
			AND      A.APPROVAL_STATUS = '승인'
 			AND      NOT EXISTS (SELECT 1 FROM cm_console.CM_PROJECT_CHATBOT X WHERE X.PROJECT_ID = #{projectId} AND X.CHATBOT_ID = A.CHATBOT_ID)
			AND      C.PROJECT_ID = #{projectId}
    </select>
    
    <select id="selectRcsCallNumList" resultType="camel">
        /* callnum.selectRcsCallNumList - RCS발신번호 목록 조회 */
		SELECT   A.CHATBOT_ID AS CALL_NUM
		,      B.BRAND_NAME AS BRAND
		,      DATE_FORMAT(A.REG_DT, '%Y-%m-%d') AS REG_DT
		,      A.CHATBOT_ID
		FROM   cm.CM_RCS_CHATBOT A
		INNER JOIN cm.CM_RCS_BRAND B
  		 ON   B.BRAND_ID = A.BRAND_ID 
   		AND   B.USE_YN = 'Y'
   		AND   B.APPROVAL_STATUS = '승인'
		INNER JOIN cm_console.CM_PROJECT_BRAND C
 		  ON   C.BRAND_ID = B.BRAND_ID 
		WHERE   A.USE_YN = 'Y'
			AND      A.APPROVAL_STATUS = '승인'
 			AND      NOT EXISTS (SELECT 1 FROM cm_console.CM_PROJECT_CHATBOT X WHERE X.PROJECT_ID = #{projectId} AND X.CHATBOT_ID = A.CHATBOT_ID)
			AND      C.PROJECT_ID = #{projectId}
		ORDER BY A.REG_DT DESC
        <if test='pagingYn == "Y" '>
         LIMIT #{offset}, #{listSize}
        </if>
    </select>
    
    <select id="selectSmsCallNumCnt" resultType="int">
        /* callnum.selectSmsCallNumCnt - 문자발신번호 건수 조회 */
        SELECT COUNT(1) AS CNT 
          FROM cm_console.CM_CALL_NUM a
         WHERE a.CORP_ID       = #{corpId}
           AND REG_WAY         IN ('PHONE','DOC','PROXY','ETC')
           AND NOT EXISTS (SELECT 1 
               FROM cm_console.CM_PROJECT_CALL_NUM c
              WHERE a.CORP_ID    = c.CORP_ID
                AND a.CALL_NUM   = c.CALL_NUM
                AND c.PROJECT_ID = #{projectId})
    </select>
    
    <select id="selectSmsCallNumList" resultType="camel">
        /* callnum.selectSmsCallNumList - 문자발신번호 목록 조회 */
        SELECT a.CALL_NUM
             , (CASE REG_WAY WHEN 'PHONE' THEN '휴대폰 인증' WHEN 'DOC' THEN '서류 심사' WHEN 'PROXY' THEN '대리인' WHEN 'ETC' THEN '기타' END) AS REG_WAY
             , DATE_FORMAT(a.REG_DT, '%Y-%m-%d')    AS REG_DT 
          FROM cm_console.CM_CALL_NUM a
         WHERE a.CORP_ID       = #{corpId}
           AND REG_WAY         IN ('PHONE','DOC','PROXY','ETC')
           AND NOT EXISTS (SELECT 1 
               FROM cm_console.CM_PROJECT_CALL_NUM c
              WHERE a.CORP_ID    = c.CORP_ID
                AND a.CALL_NUM   = c.CALL_NUM
                AND c.PROJECT_ID = #{projectId})
         ORDER BY REG_DT DESC
        <if test='pagingYn == "Y" '>
         LIMIT #{offset}, #{listSize}
        </if>
    </select>
</mapper>