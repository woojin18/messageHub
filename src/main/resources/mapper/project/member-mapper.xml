<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="member">
	<select id="selectProjectMemberListCnt" resultType="int">
		/* member.selectProjectMemberListCnt - 멤버 목록 조회 카운트*/
		SELECT	COUNT(*) AS CNT
		FROM cm_console.CM_PROJECT_USER A
		INNER JOIN cm_console.CM_USER B
		WHERE A.USER_ID = B.USER_ID
		AND B.DEL_YN = 'N'
		AND A.PROJECT_ID = #{projectId}
		AND A.CORP_ID = #{corpId}
		AND B.ROLE_CD IN ('ADMIN', 'USER', 'OWNER')
		<if test="userName != '' and userName != null ">
		AND B.USER_NAME LIKE CONCAT('%', #{userName}, '%')
		</if>
		<if test="loginId != '' and loginId != null ">
		AND B.LOGIN_ID LIKE CONCAT('%', #{loginId}, '%')
		</if>
		<if test="roleCd != '' and roleCd != null ">
		AND B.ROLE_CD = #{roleCd}
		</if>
		<if test="approvalStatus != '' and approvalStatus != null ">
		AND B.APPROVAL_STATUS = #{approvalStatus}
		</if>
	</select>
	
	<select id="selectProjectMemberList" resultType="camel">
		/* member.selectProjectMemberList - 멤버 목록 조회 */
		SELECT	@ROWNUM := @ROWNUM + 1 AS ROWNUM
		,		A.PROJECT_ID
		,		A.CORP_ID
		,		A.USER_ID
		,		B.LOGIN_ID
		,		B.USER_NAME
		,		B.LOGIN_PWD
		,		B.PWD_UPD_DT
		,		B.HP_NUMBER
		,		B.RECENT_CONN_DT
		,		B.SMS_CERTIFY_NUMBER
		,		B.LOGIN_FAIL_CNT
		,		B.MAIL_CERTIFY_NUMBER
		,		B.MAIL_CERTIFY_SENDER_DT
		,		B.APPROVAL_STATUS
		,		(	SELECT	CODE_NAME_1
					FROM	cm_bo.CM_CODE
					WHERE	CODE_TYPE_CD = 'APPROVAL_STATUS'
					AND		CODE_VAL_1 = B.APPROVAL_STATUS
				) AS APPROVAL_STATUS_NAME
		,		B.DEL_YN
		,		B.ROLE_CD
		,		(	SELECT	ROLE_NAME
					FROM	cm_bo.CM_ROLE
					WHERE	ROLE_CD = B.ROLE_CD
					AND		SVC_TYPE_CD IN ('AC','UC')
				) AS ROLE_NAME
		,		B.RESEND_TITLE
		,		B.REP_PROJECT_ID
		FROM cm_console.CM_PROJECT_USER A
		INNER JOIN (SELECT @rownum:=0) T2
		INNER JOIN cm_console.CM_USER B
		WHERE A.USER_ID = B.USER_ID
		AND B.DEL_YN = 'N'
		AND A.PROJECT_ID = #{projectId}
		AND A.CORP_ID = #{corpId}
		AND B.ROLE_CD IN ('ADMIN', 'USER', 'OWNER')
		<if test="userName != '' and userName != null ">
		AND B.USER_NAME LIKE CONCAT('%', #{userName}, '%')
		</if>
		<if test="loginId != '' and loginId != null ">
		AND B.LOGIN_ID LIKE CONCAT('%', #{loginId}, '%')
		</if>
		<if test="roleCd != '' and roleCd != null ">
		AND B.ROLE_CD = #{roleCd}
		</if>
		<if test="approvalStatus != '' and approvalStatus != null ">
		AND B.APPROVAL_STATUS = #{approvalStatus}
		</if>
		<if test='pagingYn == "Y" '>
		LIMIT ${offset}, #{listSize}
		</if>
	</select>
	
	<insert id="insertProjectMember">
		/* member.insertProjectMember - 멤버 등록 */
		INSERT INTO cm_console.CM_PROJECT_USER (
					PROJECT_ID
			,		CORP_ID
			,		USER_ID
			,		REG_ID
			,		REG_DT
			) VALUES (
					#{projectId}
			,		#{corpId}
			,		#{userId}
			,		#{loginId}
			,		NOW()
		)
	</insert>
	
	<delete id="deleteProjectMember" parameterType="hashmap">
		/* member.deleteProjectMember - 멤버 삭제 */
		DELETE	FROM cm_console.CM_PROJECT_USER
		WHERE	PROJECT_ID = #{projectId}
		AND		USER_ID = #{userId}
	</delete>
	<!-- 
		SELECT *
		FROM (
			SELECT	A.USER_NAME
			,	A.USER_ID
			,	A.ROLE_CD
			,	A.APPROVAL_STATUS
			,	(	SELECT	CODE_NAME_1
					FROM	cm_bo.CM_CODE
					WHERE	CODE_TYPE_CD = 'APPROVAL_STATUS'
					AND		CODE_VAL_1 = A.APPROVAL_STATUS
				) AS APPROVAL_STATUS_NAME
			,	A.LOGIN_ID
			,	A.HP_NUMBER
			,	A.CORP_ID
				FROM	cm_console.CM_USER A
				WHERE	A.DEL_YN	= 'N'
				AND		A.CORP_ID	= 'COM2104142281316' 
			) A LEFT OUTER JOIN (	SELECT A.USER_ID
									FROM cm_console.CM_PROJECT_USER A
									INNER JOIN cm_console.CM_USER B
									WHERE A.USER_ID = B.USER_ID
									AND B.DEL_YN = 'N'
									AND A.PROJECT_ID = 'PJT210429130357'
									AND A.CORP_ID = 'COM2104142281316'
									AND B.ROLE_CD IN ('ADMIN', 'USER', 'OWNER')
								) B
		ON A.USER_ID = B.USER_ID
		WHERE B.USER_ID IS NULL
	 -->
	<select id="selectProjectUserListCnt" resultType="int">
		/* member.selectProjectUserListCnt 사용자 리스트 카운트 조회 */
		SELECT	COUNT(A.USER_ID) AS CNT
			FROM	cm_console.CM_USER A
			WHERE	A.DEL_YN	= 'N'
			AND		A.CORP_ID	= #{corpId}
			<if test="searchText != '' and searchText != null ">
				<if test="searchTextType == 'loginId' ">
			AND		A.LOGIN_ID LIKE CONCAT('%', #{searchText}, '%')
				</if>
				<if test="searchTextType == 'userName' ">
			AND		A.USER_NAME LIKE CONCAT('%', #{searchText}, '%')
				</if>
				<if test="searchTextType == 'approvalStatus' ">
			AND		A.APPROVAL_STATUS = #{searchText}
				</if>
			</if>
	</select>
	
	<select id="selectProjectUserList" resultType="camel">
		/* member.selectProjectUserList 사용자 리스트 조회 */
		SELECT * FROM (
			SELECT	@ROWNUM := @ROWNUM + 1 AS ROWNUM
			,	A.USER_NAME
			,	A.USER_ID
			,	A.ROLE_CD
			,	A.APPROVAL_STATUS
			,	(	SELECT	CODE_NAME_1
					FROM	cm_bo.CM_CODE
					WHERE	CODE_TYPE_CD = 'APPROVAL_STATUS'
					AND		CODE_VAL_1 = A.APPROVAL_STATUS
				) AS APPROVAL_STATUS_NAME
			,	A.LOGIN_ID
			,	A.HP_NUMBER
			,	A.CORP_ID
			FROM	cm_console.CM_USER A
			, (SELECT @rownum:=0) T2
			WHERE	A.DEL_YN	= 'N'
			AND		A.CORP_ID	= #{corpId}
			<if test="searchText != '' and searchText != null ">
				<if test="searchTextType == 'loginId' ">
			AND		A.LOGIN_ID LIKE CONCAT('%', #{searchText}, '%')
				</if>
				<if test="searchTextType == 'userName' ">
			AND		A.USER_NAME LIKE CONCAT('%', #{searchText}, '%')
				</if>
				<if test="searchTextType == 'approvalStatus' ">
			AND		A.APPROVAL_STATUS = #{searchText}
				</if>
			</if>
		) A LEFT OUTER JOIN (	SELECT	A.USER_ID
								FROM cm_console.CM_PROJECT_USER A
								INNER JOIN cm_console.CM_USER B
								WHERE A.USER_ID = B.USER_ID
								AND B.DEL_YN = 'N'
								AND A.PROJECT_ID = #{projectId}
								AND A.CORP_ID = #{corpId}
								AND B.ROLE_CD IN ('ADMIN', 'USER', 'OWNER')
							) B
		ON A.USER_ID = B.USER_ID
		WHERE B.USER_ID IS NULL
		<if test='pagingYn == "Y" '>
		LIMIT ${offset}, #{listSize}
		</if>
	</select>
</mapper>