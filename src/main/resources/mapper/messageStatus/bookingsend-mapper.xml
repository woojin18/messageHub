<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bookingSend">

    <sql id ="whereSelectBookingSendList">
        <!-- AND A.CORP_ID = #{corpId} -->
		AND A.PROJECT_ID = #{projectId}
		AND A.RESV_SENDER_YN = 'Y'
		AND A.DEL_YN = 'N'
		<if test="searchText != '' and searchText != null ">
            AND C.CORP_NAME like CONCAT('%', #{searchText}, '%')
        </if>
        <if test="searchStartDate != '' and searchStartDate != null ">
            <if test="searchEndDate != '' and searchEndDate != null ">
            AND A.REG_DT BETWEEN CONCAT(#{searchStartDate}, ' 00:00:00') AND CONCAT(#{searchEndDate}, ' 23:59:59')
            </if>
        </if>
    </sql>

    <select id="selectBookingSendListCnt" parameterType="hashmap" resultType="int">
    /* 예약발송 현황 리스트 카운트 조회 */
        SELECT
            COUNT(DISTINCT A.WEB_REQ_ID) AS CNT
        FROM cm_console.CM_WEB_MSG A LEFT OUTER JOIN cm_console.CM_CORP C ON A.CORP_ID = C.CORP_ID
        WHERE 1=1
        <include refid="whereSelectBookingSendList"/>
    </select>

    <select id="selectBookingSendList" parameterType="hashmap" resultType="camel">
    /* 예약발송 현황 리스트 조회 */
		SELECT  @rownum:=@rownum+1 AS ROW_NUM
		      , A.WEB_REQ_ID
		      , A.CH_STRING
			   , A.SENDER_TYPE
			   , CASE WHEN A.SENDER_TYPE = 'C' THEN '개별방송'
		        WHEN A.SENDER_TYPE = 'M' THEN '통합발송'
		        WHEN A.SENDER_TYPE = 'S' THEN '스마트발송'
		        END AS SENDER_TYPE_NM /*발송타입명*/
			   , A.SENDER_CNT
			   , DATE_FORMAT(A.REG_DT, '%Y.%m.%d %H:%i:%s') AS REG_DT /*등록일시*/
			   , DATE_FORMAT(A.REQ_DT, '%Y.%m.%d %H:%i:%s') AS REQ_DT /*예약발송일시*/
			    , CASE WHEN A.REQ_DT <![CDATA[<=]]> NOW() THEN 'FALSE'
			          ELSE 'TRUE'
			          END AS CANCEL_SHOW_FLAG
			   , C.CORP_NAME
			   , A.MSG_INFO->>'$.send_info[1].chType' AS REPLC_SEND
			   <!--  , CONCAT(A.MSG_INFO->>'$.send_info[0].chType', ' : ', '\n', A.MSG_INFO->>'$.send_info[0].content', '\n', A.MSG_INFO->>'$.send_info[1].chType', ' : ', '\n', A.MSG_INFO->>'$.send_info[1].content') AS CONTENT-->
			   , A.MSG_INFO->>'$.msg' AS CONTENT
		FROM cm_console.CM_WEB_MSG A LEFT OUTER JOIN cm_console.CM_CORP C ON A.CORP_ID = C.CORP_ID
		   , (SELECT @rownum:=0) TMP
		WHERE 1=1
		<include refid="whereSelectBookingSendList"/>
		ORDER BY REG_DT DESC
        <if test='pagingYn == "Y" '>
        LIMIT #{offset}, #{listSize}
        </if>
    </select>

	<update id="cancelBookingSend">
		/* 예약발송 취소 */
		UPDATE	cm_console.CM_WEB_MSG
		SET		DEL_YN = 'Y'
		,		RESV_CNCL_REASON = #{cancelCause}
		WHERE	WEB_REQ_ID = #{webReqId}
	</update>


</mapper>