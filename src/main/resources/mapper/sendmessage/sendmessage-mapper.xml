<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sendMessage">

    <select id="selectAppIdList" parameterType="hashmap" resultType="camel">
    /* sendMessage.selectAppIdList APP ID 리스트 조회 */
        SELECT APLN_ID
        FROM CM_PUSH_SET
        WHERE 1=1
            AND CORP_ID = #{corpId}
            AND OTHER_PROJECT_USE_YN = 'Y' OR PROJECT_ID = #{projectId}
    </select>

    <select id="selectCallbackList" parameterType="hashmap" resultType="camel">
    /* sendMessage.selectCallbackList 발신번호 조회 */
        SELECT CHATBOT_ID AS CALLBACK /* 챗봇(대화방)ID, A2P의 경우 발신번호(mdn)과 동일 */
        FROM cm.CM_RCS_CHATBOT
        WHERE SVC_TYPE = 'A2P'
            AND CORP_ID = #{corpId}
    </select>

    <select id="selectAddrGrpList" parameterType="hashmap" resultType="camel">
    /* sendMessage.selectAddrGrpList 주소록 그룹 목록 조회 */
        SELECT
            CACG.ADDRESS_CATEGORY_GRP_ID
            , NULL AS ADDRESS_CATEGORY_ID
            , CACG.DIS_ORDER AS GRP_DIS_ORDER
            , NULL AS DIS_ORDER
            , CACG.ADDRESS_CATEGORY_GRP_NAME AS ADDRESS_NAME
            , NULL AS PAR_ADDRESS_CATEGORY_ID
        FROM CM_ADDR_CATE_GRP CACG
        WHERE CACG.USE_YN = 'Y'
            AND CACG.CORP_ID = #{corpId}
            AND CACG.OTHER_PROJECT_USE_YN = 'Y' OR CACG.PROJECT_ID = #{projectId}
        ORDER BY CACG.DIS_ORDER
    </select>

    <select id="selectAddrCtgyList" parameterType="hashmap" resultType="camel">
    /* sendMessage.selectAddrCtgyList 주소록 카테고리 목록 조회 */
        SELECT
            CAC.ADDRESS_CATEGORY_ID
            , CAC.ADDRESS_CATEGORY_GRP_ID
            , NULL AS GRP_DIS_ORDER
            , CAC.DIS_ORDER
            , CAC.ADDRESS_CATEGORY_NAME  AS ADDRESS_NAME
            , CAC.PAR_ADDRESS_CATEGORY_ID
        FROM CM_ADDR_CATE_GRP CACG
        <if test="searchText != '' and searchText != null ">
        INNER JOIN (
            SELECT @ids := GROUP_CONCAT(DISTINCT XCACM.ADDRESS_CATEGORY_ID)
            FROM CM_ADDR_CATE_MEM XCACM
            INNER JOIN CM_CU_INFO XCCI
                ON XCACM.CU_INFO_ID = XCCI.CU_INFO_ID
                AND XCCI.USE_YN = 'Y'
            WHERE 1=1
                <if test="searchTextType == 'cuid' ">
                    AND XCCI.CUID LIKE CONCAT('%', #{searchText}, '%')
                </if>
                <if test="searchTextType == 'cuName' ">
                    AND XCCI.CU_NAME LIKE CONCAT('%', #{searchText}, '%')
                </if>
                <if test="searchTextType == 'hpNumber' ">
                    AND XCCI.HP_NUMBER LIKE CONCAT('%', #{searchText}, '%')
                </if>
        ) VARS
        </if>
        INNER JOIN CM_ADDR_CATE CAC
            ON CACG.ADDRESS_CATEGORY_GRP_ID = CAC.ADDRESS_CATEGORY_GRP_ID
            AND CAC.DEL_YN = 'N'
        <if test="searchText != '' and searchText != null and searchTextType != '' and searchTextType != null ">
            AND FIND_IN_SET(CAC.ADDRESS_CATEGORY_ID, fnc_addr_hierarchi_id(@ids))
        </if>
        WHERE CACG.USE_YN = 'Y'
            AND CACG.CORP_ID = #{corpId}
            AND CACG.OTHER_PROJECT_USE_YN = 'Y' OR CACG.PROJECT_ID = #{projectId}
        ORDER BY CAC.DIS_ORDER
    </select>

    <sql id ="whereSelectCmCuList">
        AND CACM.ADDRESS_CATEGORY_ID = #{addressCategoryId}
        <if test="searchText != '' and searchText != null ">
            <if test="searchTextType == 'cuid' ">
                AND CCI.CUID LIKE CONCAT('%', #{searchText}, '%')
            </if>
            <if test="searchTextType == 'cuName' ">
                AND CCI.CU_NAME LIKE CONCAT('%', #{searchText}, '%')
            </if>
            <if test="searchTextType == 'hpNumber' ">
                AND CCI.HP_NUMBER LIKE CONCAT('%', #{searchText}, '%')
            </if>
        </if>
    </sql>

    <select id="selectCmCuListCnt" parameterType="hashmap" resultType="int">
    /* sendMessage.selectCmCuListCnt 주소록 카테고리 구성원 목록 카운트 조회 */
        SELECT
            COUNT(*) AS CNT
        FROM CM_ADDR_CATE_MEM CACM
        INNER JOIN CM_CU_INFO CCI
            ON CACM.CU_INFO_ID = CCI.CU_INFO_ID
            AND CCI.USE_YN = 'Y'
        WHERE 1=1
        <include refid="whereSelectCmCuList"/>
    </select>

    <select id="selectCmCuList" parameterType="hashmap" resultType="camel">
    /* sendMessage.selectCmCuList 주소록 카테고리 구성원 목록 조회 */
        SELECT
            CCI.CU_INFO_ID
            , CCI.CU_NAME
            , CCI.CUID
            , CCI.HP_NUMBER
            , CCI.EMAIL
        FROM CM_ADDR_CATE_MEM CACM
        INNER JOIN CM_CU_INFO CCI
            ON CACM.CU_INFO_ID = CCI.CU_INFO_ID
            AND CCI.USE_YN = 'Y'
        WHERE 1=1
        <include refid="whereSelectCmCuList"/>
        ORDER BY CU_INFO_ID
        <if test='pagingYn == "Y" '>
        LIMIT ${offset}, #{listSize}
        </if>
    </select>
























    <insert id="qryInsertSendPushMessage" parameterType="hashmap">
        /* 푸시 메시지 발송내역 등록 */
        INSERT INTO CM_WEB_MSG
        (
            WEB_REQ_ID,
            CORP_ID,
            PROJECT_ID,
            API_KEY,
            CH_GRP,
            CH,
            MSG_INFO,
            CU_INFO,
            SENDER_CNT,
            CALLBACK,
            CAMPAIGN_ID,
            SENDER_TYPE,
            STATUS,
            GW_RESULT_CODE,
            GW_RESULT_DESC,
            RESV_SENDER_YN,
            REG_DT,
            REQ_DT,
        )
        VALUES
        (
            #{webReqId},
            #{corpId},
            #{projectId},
            #{apiKey},
            #{chGrp},
            #{ch},
            #{msgInfo},
            #{cuInfo},
            #{senderCnt},
            #{callback},
            #{campaignId},
            #{senderType},
            #{status},
            #{gwResultCode},
            #{gwResultDesc},
            #{resvSenderYn},
            SYSDATE,
            SYSDATE
           )
    </insert>

</mapper>